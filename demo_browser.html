<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSF Sign Language Demo - 99% Accuracy | 35 Conditions</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 32px;
            padding: 16px 20px;
            background: rgba(255,255,255,0.1);
            margin-top: 24px;
            border-radius: 12px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }
        
        /* Main Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px 20px;
        }
        
        /* Card */
        .card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        /* Input Section */
        .input-section {
            display: flex;
            gap: 12px;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 16px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            outline: none;
            transition: all 0.2s;
        }
        
        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        input[type="text"]::placeholder {
            color: #94a3b8;
        }
        
        .btn {
            padding: 16px 32px;
            font-size: 1rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        
        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .slot-card {
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .slot-card.active {
            background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%);
            transform: scale(1.02);
        }
        
        .slot-card.condition-active {
            background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
            border: 2px solid var(--success);
        }
        
        .slot-name {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        
        .slot-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .slot-value.none {
            color: #cbd5e1;
            font-weight: 400;
        }
        
        /* GLOSS Output */
        .gloss-output {
            margin-top: 24px;
            padding: 24px;
            background: linear-gradient(135deg, #1e3a8a 0%, #5b21b6 100%);
            border-radius: 16px;
            text-align: center;
            color: white;
        }
        
        .gloss-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        
        .gloss-value {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 3px;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        
        .gloss-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Condition Categories */
        .conditions-section {
            margin-top: 24px;
        }
        
        .condition-categories {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .condition-category {
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .condition-category:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .condition-category.active {
            background: #dbeafe;
            border-color: var(--primary);
        }
        
        .category-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .category-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .category-count {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        /* Examples */
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .example-card {
            padding: 14px 16px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .example-card:hover {
            background: #dbeafe;
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .example-text {
            font-size: 0.95rem;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .example-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .lang-badge {
            padding: 2px 8px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .condition-badge {
            padding: 2px 8px;
            background: var(--success);
            color: white;
            border-radius: 4px;
        }
        
        /* Status */
        .status {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .status.loading::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Latency Badge */
        .latency-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 12px;
        }
        
        .latency-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 32px 20px;
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.75rem; }
            .stats-bar { flex-wrap: wrap; gap: 16px; }
            .results-grid { grid-template-columns: repeat(2, 1fr); }
            .condition-categories { grid-template-columns: repeat(2, 1fr); }
            .examples-grid { grid-template-columns: 1fr; }
            .input-section { flex-direction: column; }
            .gloss-value { font-size: 1.5rem; letter-spacing: 2px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>ü§ü CSF Sign Language</h1>
        <p>Direct Multilingual ‚Üí ASL GLOSS Translation (No English Required)</p>
        
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value">99.03%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat">
                <div class="stat-value">0.74 MB</div>
                <div class="stat-label">Model Size</div>
            </div>
            <div class="stat">
                <div class="stat-value">35</div>
                <div class="stat-label">Conditions</div>
            </div>
            <div class="stat">
                <div class="stat-value">4</div>
                <div class="stat-label">Languages</div>
            </div>
        </div>
    </header>
    
    <main class="container">
        <!-- Input Card -->
        <div class="card">
            <div class="card-title">‚úçÔ∏è Enter Text in Any Language</div>
            <div class="input-section">
                <div class="input-wrapper">
                    <input type="text" id="textInput" placeholder="Try: If I'm tired, I rest at home...">
                </div>
                <button class="btn" id="predictBtn" onclick="predict()">
                    <span>Extract</span>
                    <span>‚Üí</span>
                </button>
            </div>
            
            <div id="status" class="status loading">Loading model (0.74 MB)...</div>
            
            <div id="resultsContainer" style="display: none;">
                <div class="results-grid" id="results"></div>
                
                <div class="gloss-output" id="glossOutput">
                    <div class="gloss-label">ASL GLOSS Output</div>
                    <div class="gloss-value" id="glossValue">‚Äî</div>
                    <div class="gloss-arrow">
                        <span id="inputEcho"></span>
                        <span>‚Üí</span>
                        <span id="glossEcho"></span>
                    </div>
                    <div class="latency-badge">
                        <span class="latency-dot"></span>
                        <span id="latencyValue">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Condition Categories -->
        <div class="card conditions-section">
            <div class="card-title">üéØ 35 Condition Types (99.4% Accuracy)</div>
            <div class="condition-categories">
                <div class="condition-category" onclick="showCategoryExamples('weather')">
                    <div class="category-icon">üå§Ô∏è</div>
                    <div class="category-name">Weather</div>
                    <div class="category-count">5 conditions</div>
                </div>
                <div class="condition-category" onclick="showCategoryExamples('time')">
                    <div class="category-icon">‚è∞</div>
                    <div class="category-name">Time</div>
                    <div class="category-count">5 conditions</div>
                </div>
                <div class="condition-category" onclick="showCategoryExamples('health')">
                    <div class="category-icon">üí™</div>
                    <div class="category-name">Health</div>
                    <div class="category-count">5 conditions</div>
                </div>
                <div class="condition-category" onclick="showCategoryExamples('schedule')">
                    <div class="category-icon">üìÖ</div>
                    <div class="category-name">Schedule</div>
                    <div class="category-count">4 conditions</div>
                </div>
                <div class="condition-category" onclick="showCategoryExamples('mood')">
                    <div class="category-icon">üòä</div>
                    <div class="category-name">Mood</div>
                    <div class="category-count">5 conditions</div>
                </div>
                <div class="condition-category" onclick="showCategoryExamples('social')">
                    <div class="category-icon">üë•</div>
                    <div class="category-name">Social</div>
                    <div class="category-count">3 conditions</div>
                </div>
                <div class="condition-category" onclick="showCategoryExamples('activity')">
                    <div class="category-icon">üé¨</div>
                    <div class="category-name">Activity</div>
                    <div class="category-count">5 conditions</div>
                </div>
                <div class="condition-category" onclick="showCategoryExamples('financial')">
                    <div class="category-icon">üí∞</div>
                    <div class="category-name">Financial</div>
                    <div class="category-count">2 conditions</div>
                </div>
            </div>
        </div>
        
        <!-- Examples -->
        <div class="card">
            <div class="card-title" id="examplesTitle">üåç Try These Examples</div>
            <div class="examples-grid" id="examplesGrid">
                <!-- Weather -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">If it rains, I stay home.</div>
                    <div class="example-meta">
                        <span class="lang-badge">EN</span>
                        <span class="condition-badge">IF_RAIN</span>
                    </div>
                </div>
                <!-- Health -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">When I'm tired, I take a nap.</div>
                    <div class="example-meta">
                        <span class="lang-badge">EN</span>
                        <span class="condition-badge">IF_TIRED</span>
                    </div>
                </div>
                <!-- Mood -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">If I'm bored, I watch Netflix.</div>
                    <div class="example-meta">
                        <span class="lang-badge">EN</span>
                        <span class="condition-badge">IF_BORED</span>
                    </div>
                </div>
                <!-- Activity -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">After work, I go home.</div>
                    <div class="example-meta">
                        <span class="lang-badge">EN</span>
                        <span class="condition-badge">IF_FINISH_WORK</span>
                    </div>
                </div>
                <!-- Financial -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">If I have money, I go shopping.</div>
                    <div class="example-meta">
                        <span class="lang-badge">EN</span>
                        <span class="condition-badge">IF_HAVE_MONEY</span>
                    </div>
                </div>
                <!-- Vietnamese -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">N·∫øu ƒë√≥i th√¨ t√¥i ƒÉn.</div>
                    <div class="example-meta">
                        <span class="lang-badge">VI</span>
                        <span class="condition-badge">IF_HUNGRY</span>
                    </div>
                </div>
                <!-- Japanese -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">ÊòéÊó•„ÄÅÂ≠¶Ê†°„Å´Ë°å„Åç„Åæ„Åô„ÄÇ</div>
                    <div class="example-meta">
                        <span class="lang-badge">JA</span>
                        <span class="condition-badge">NONE</span>
                    </div>
                </div>
                <!-- French -->
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">Si je suis fatigu√©, je me repose.</div>
                    <div class="example-meta">
                        <span class="lang-badge">FR</span>
                        <span class="condition-badge">IF_TIRED</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <p>
            <strong>CSF: Contrastive Semantic Features</strong><br>
            By <a href="mailto:transybao93@gmail.com">Tran Sy Bao</a> ‚Ä¢ 
            <a href="https://github.com/transybao1393/csf-sign-language" target="_blank">GitHub</a> ‚Ä¢ 
            <a href="https://arxiv.org/abs/2501.XXXXX" target="_blank">arXiv Paper</a>
        </p>
        <p style="margin-top: 8px; opacity: 0.7;">
            0.74 MB model ‚Ä¢ 3.02ms inference ‚Ä¢ 99.03% accuracy ‚Ä¢ Browser-ready
        </p>
    </footer>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        
        const SLOT_NAMES = ["event", "intent", "time", "condition", "agent", "object", "location", "purpose", "modifier"];
        
        const ID_TO_LABEL = {
            event: ["GO", "STAY", "BUY", "WORK", "MEET", "EAT", "LEARN"],
            intent: ["NONE", "PLAN", "WANT", "DECIDE"],
            time: ["NONE", "TODAY", "TOMORROW", "YESTERDAY", "NOW"],
            condition: [
                "NONE",
                // Weather (5)
                "IF_RAIN", "IF_SUNNY", "IF_COLD", "IF_HOT", "IF_WINDY",
                // Time (5)
                "IF_LATE", "IF_EARLY", "IF_WEEKEND", "IF_NIGHT", "IF_MORNING",
                // Health (5)
                "IF_SICK", "IF_TIRED", "IF_HUNGRY", "IF_THIRSTY", "IF_FULL",
                // Schedule (4)
                "IF_BUSY", "IF_FREE", "IF_HOLIDAY", "IF_WORKING",
                // Mood (5)
                "IF_BORED", "IF_HAPPY", "IF_SAD", "IF_STRESSED", "IF_ANGRY",
                // Social (3)
                "IF_ALONE", "IF_WITH_FRIENDS", "IF_WITH_FAMILY",
                // Activity (5)
                "IF_FINISH_WORK", "IF_FINISH_SCHOOL", "IF_FINISH_EATING", "IF_WATCH_MOVIE", "IF_LISTEN_MUSIC",
                // Financial (2)
                "IF_HAVE_MONEY", "IF_NO_MONEY"
            ],
            agent: ["ME", "YOU", "HE", "SHE", "THEY"],
            object: ["NONE", "FOOD", "BOOK", "MEDICINE", "THING"],
            location: ["NONE", "HOME", "SCHOOL", "HOSPITAL", "OFFICE", "STORE"],
            purpose: ["NONE", "REST"],
            modifier: ["NONE", "FAST", "SLOW", "ALONE"]
        };
        
        const GLOSS_ORDER = ["modifier", "time", "condition", "agent", "location", "object", "event", "purpose"];
        
        // Category examples for dynamic loading
        const CATEGORY_EXAMPLES = {
            weather: [
                { text: "If it rains, I stay home.", lang: "EN", cond: "IF_RAIN" },
                { text: "If it's sunny, I go to the park.", lang: "EN", cond: "IF_SUNNY" },
                { text: "N·∫øu tr·ªùi l·∫°nh th√¨ t√¥i ·ªü nh√†.", lang: "VI", cond: "IF_COLD" },
                { text: "Êöë„Åã„Å£„Åü„Çâ„ÄÅÂÆ∂„Å´„ÅÑ„Åæ„Åô„ÄÇ", lang: "JA", cond: "IF_HOT" },
            ],
            time: [
                { text: "On the weekend, I sleep in.", lang: "EN", cond: "IF_WEEKEND" },
                { text: "If I'm late, I skip breakfast.", lang: "EN", cond: "IF_LATE" },
                { text: "Bu·ªïi s√°ng t√¥i ƒëi l√†m.", lang: "VI", cond: "IF_MORNING" },
                { text: "Le soir, je me repose.", lang: "FR", cond: "IF_NIGHT" },
            ],
            health: [
                { text: "If I'm sick, I stay home.", lang: "EN", cond: "IF_SICK" },
                { text: "When I'm tired, I take a nap.", lang: "EN", cond: "IF_TIRED" },
                { text: "N·∫øu ƒë√≥i th√¨ t√¥i ƒÉn.", lang: "VI", cond: "IF_HUNGRY" },
                { text: "Si j'ai soif, je bois.", lang: "FR", cond: "IF_THIRSTY" },
            ],
            schedule: [
                { text: "If I'm busy, I skip lunch.", lang: "EN", cond: "IF_BUSY" },
                { text: "If I'm free, I meet friends.", lang: "EN", cond: "IF_FREE" },
                { text: "Ng√†y l·ªÖ t√¥i ·ªü nh√†.", lang: "VI", cond: "IF_HOLIDAY" },
                { text: "Si je travaille, je reste au bureau.", lang: "FR", cond: "IF_WORKING" },
            ],
            mood: [
                { text: "If I'm bored, I watch Netflix.", lang: "EN", cond: "IF_BORED" },
                { text: "When I'm happy, I go out.", lang: "EN", cond: "IF_HAPPY" },
                { text: "N·∫øu bu·ªìn th√¨ t√¥i ·ªü nh√†.", lang: "VI", cond: "IF_SAD" },
                { text: "„Çπ„Éà„É¨„Çπ„Åå„Åü„Åæ„Å£„Åü„Çâ„ÄÅÂÆ∂„Åß‰ºë„Åø„Åæ„Åô„ÄÇ", lang: "JA", cond: "IF_STRESSED" },
            ],
            social: [
                { text: "If I'm alone, I stay home.", lang: "EN", cond: "IF_ALONE" },
                { text: "With friends, I go to the store.", lang: "EN", cond: "IF_WITH_FRIENDS" },
                { text: "Khi ·ªü v·ªõi gia ƒë√¨nh, t√¥i ƒÉn.", lang: "VI", cond: "IF_WITH_FAMILY" },
            ],
            activity: [
                { text: "After work, I go home.", lang: "EN", cond: "IF_FINISH_WORK" },
                { text: "After school, I play games.", lang: "EN", cond: "IF_FINISH_SCHOOL" },
                { text: "Sau khi ƒÉn xong, t√¥i ngh·ªâ.", lang: "VI", cond: "IF_FINISH_EATING" },
                { text: "While watching a movie, I eat.", lang: "EN", cond: "IF_WATCH_MOVIE" },
            ],
            financial: [
                { text: "If I have money, I go shopping.", lang: "EN", cond: "IF_HAVE_MONEY" },
                { text: "When I'm broke, I stay home.", lang: "EN", cond: "IF_NO_MONEY" },
                { text: "N·∫øu c√≥ ti·ªÅn th√¨ t√¥i mua ƒë·ªì.", lang: "VI", cond: "IF_HAVE_MONEY" },
                { text: "Si je n'ai pas d'argent, je reste.", lang: "FR", cond: "IF_NO_MONEY" },
            ]
        };
        
        let session = null;
        let tokenizer = null;
        
        // ============================================================
        // INITIALIZATION
        // ============================================================
        
        async function init() {
            try {
                const statusEl = document.getElementById('status');
                statusEl.textContent = 'Loading ONNX model...';
                
                // Try loading with external data first
                try {
                    const externalDataResponse = await fetch('./models/model.onnx.data');
                    const externalDataBuffer = await externalDataResponse.arrayBuffer();
                    
                    session = await ort.InferenceSession.create('./models/model.onnx', {
                        externalData: [{
                            path: 'model.onnx.data',
                            data: externalDataBuffer
                        }]
                    });
                } catch (e) {
                    // Fallback to standalone model
                    console.log('Trying standalone model...');
                    session = await ort.InferenceSession.create('./models/model.onnx');
                }
                
                statusEl.textContent = 'Loading tokenizer...';
                
                const tokenizerResponse = await fetch('./models/tokenizer.json');
                tokenizer = await tokenizerResponse.json();
                
                statusEl.style.display = 'none';
                document.getElementById('predictBtn').disabled = false;
                document.getElementById('textInput').focus();
                
            } catch (e) {
                document.getElementById('status').textContent = '‚ùå Error: ' + e.message;
                document.getElementById('status').classList.remove('loading');
                console.error(e);
            }
        }
        
        // ============================================================
        // TOKENIZATION
        // ============================================================
        
        function tokenize(text, maxLength = 64) {
            const vocab = tokenizer.model.vocab;
            const vocabMap = {};
            for (const [token, id] of Object.entries(vocab)) {
                vocabMap[token] = id;
            }
            
            let tokens = [];
            
            // Add CLS token
            const clsId = vocabMap['[CLS]'] ?? vocabMap['<s>'] ?? 2;
            tokens.push(clsId);
            
            // Tokenize words
            const words = text.split(/\s+/);
            for (const word of words) {
                const wordWithSpace = 'ƒ†' + word;
                
                if (vocabMap[wordWithSpace] !== undefined) {
                    tokens.push(vocabMap[wordWithSpace]);
                } else if (vocabMap[word] !== undefined) {
                    tokens.push(vocabMap[word]);
                } else {
                    for (const char of word) {
                        if (vocabMap[char] !== undefined) {
                            tokens.push(vocabMap[char]);
                        } else {
                            tokens.push(vocabMap['[UNK]'] ?? vocabMap['<unk>'] ?? 1);
                        }
                    }
                }
            }
            
            // Add SEP token
            const sepId = vocabMap['[SEP]'] ?? vocabMap['</s>'] ?? 3;
            tokens.push(sepId);
            
            tokens = tokens.slice(0, maxLength);
            const attentionMask = tokens.map(() => 1);
            
            const padId = vocabMap['[PAD]'] ?? vocabMap['<pad>'] ?? 0;
            while (tokens.length < maxLength) {
                tokens.push(padId);
                attentionMask.push(0);
            }
            
            return { input_ids: tokens, attention_mask: attentionMask };
        }
        
        // ============================================================
        // PREDICTION
        // ============================================================
        
        async function predict() {
            const text = document.getElementById('textInput').value.trim();
            if (!text || !session || !tokenizer) return;
            
            document.getElementById('predictBtn').disabled = true;
            
            try {
                const startTime = performance.now();
                
                const encoded = tokenize(text, 64);
                
                const inputIds = new ort.Tensor('int64', BigInt64Array.from(encoded.input_ids.map(x => BigInt(x))), [1, 64]);
                const attentionMask = new ort.Tensor('int64', BigInt64Array.from(encoded.attention_mask.map(x => BigInt(x))), [1, 64]);
                
                const outputs = await session.run({
                    input_ids: inputIds,
                    attention_mask: attentionMask
                });
                
                const endTime = performance.now();
                const latency = (endTime - startTime).toFixed(2);
                
                // Parse outputs
                const slots = {};
                const outputKeys = Object.keys(outputs);
                SLOT_NAMES.forEach((slot, i) => {
                    const logits = Array.from(outputs[outputKeys[i]].data);
                    const predId = logits.indexOf(Math.max(...logits));
                    slots[slot] = ID_TO_LABEL[slot][predId] || 'NONE';
                });
                
                displayResults(slots, text, latency);
                
            } catch (e) {
                console.error(e);
                alert('Prediction error: ' + e.message);
            }
            
            document.getElementById('predictBtn').disabled = false;
        }
        
        // ============================================================
        // DISPLAY RESULTS
        // ============================================================
        
        function displayResults(slots, inputText, latency) {
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = SLOT_NAMES.map(slot => {
                const value = slots[slot];
                const isActive = value !== 'NONE' && !(slot === 'agent' && value === 'ME');
                const isCondition = slot === 'condition' && value !== 'NONE';
                
                return `
                    <div class="slot-card ${isActive ? 'active' : ''} ${isCondition ? 'condition-active' : ''}">
                        <div class="slot-name">${slot}</div>
                        <div class="slot-value ${value === 'NONE' ? 'none' : ''}">${value}</div>
                    </div>
                `;
            }).join('');
            
            // Generate GLOSS
            const glossTokens = GLOSS_ORDER
                .filter(slot => slots[slot] && slots[slot] !== 'NONE' && !(slot === 'agent' && slots[slot] === 'ME'))
                .map(slot => slots[slot]);
            
            const glossOutput = glossTokens.join(' ') || '‚Äî';
            
            document.getElementById('glossValue').textContent = glossOutput;
            document.getElementById('inputEcho').textContent = inputText.length > 40 ? inputText.substring(0, 40) + '...' : inputText;
            document.getElementById('glossEcho').textContent = glossOutput;
            document.getElementById('latencyValue').textContent = `${latency}ms`;
            
            document.getElementById('resultsContainer').style.display = 'block';
        }
        
        // ============================================================
        // EXAMPLES
        // ============================================================
        
        function tryExample(el) {
            const text = el.querySelector('.example-text').textContent;
            document.getElementById('textInput').value = text;
            predict();
        }
        
        function showCategoryExamples(category) {
            // Update active state
            document.querySelectorAll('.condition-category').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update title
            const categoryNames = {
                weather: 'üå§Ô∏è Weather Conditions',
                time: '‚è∞ Time Conditions',
                health: 'üí™ Health Conditions',
                schedule: 'üìÖ Schedule Conditions',
                mood: 'üòä Mood Conditions',
                social: 'üë• Social Conditions',
                activity: 'üé¨ Activity Conditions',
                financial: 'üí∞ Financial Conditions'
            };
            document.getElementById('examplesTitle').textContent = categoryNames[category];
            
            // Update examples
            const examples = CATEGORY_EXAMPLES[category];
            const grid = document.getElementById('examplesGrid');
            
            grid.innerHTML = examples.map(ex => `
                <div class="example-card" onclick="tryExample(this)">
                    <div class="example-text">${ex.text}</div>
                    <div class="example-meta">
                        <span class="lang-badge">${ex.lang}</span>
                        <span class="condition-badge">${ex.cond}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // ============================================================
        // KEYBOARD SHORTCUTS
        // ============================================================
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !document.getElementById('predictBtn').disabled) {
                predict();
            }
        });
        
        // ============================================================
        // INITIALIZE
        // ============================================================
        
        document.getElementById('predictBtn').disabled = true;
        init();
    </script>
</body>
</html>